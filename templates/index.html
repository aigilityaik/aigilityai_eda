<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Analysis Application</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            background: #FFE4E1;
            /* Misty Rose */
            color: #5C4033;
            /* Dark Brown for contrast */
            overflow-x: hidden;
            animation: fadeInAnimation ease 3s;
            animation-iteration-count: 1;
            animation-fill-mode: forwards;
            min-height: 100vh;
        }

        nav {
            background-color: #FFB7C5;
            /* Light Pink */
            color: #4A2C2A;
            /* Dark Reddish Brown */
            padding: 0 20px;
            line-height: 56px;
            /* Aligns nav items vertically */
            font-size: 20px;
        }

        /* nav .nav-wrapper {
            align-items: center;
            justify-content: space-between;
            display: flex;
        } */

        nav .nav-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        nav button {
            background-color: #FFD700;
            /* Gold color to make button pop */
            color: #333;
            /* Dark text for contrast */
            border: none;
            border-radius: 4px;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
        }

        nav button:hover {
            background-color: #E6C300;
            /* Slightly darker gold on hover */
        }

        #taskCards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        #taskCards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* Two cards per line */
            gap: 20px;
            padding: 20px;
        }

        .card {
            background-color: #FFC0CB;
            /* Light Pink */
            color: #5C4033;
            border: 1px solid #FF69B4;
            /* Hot Pink for borders */
            border-top: 1px solid #444;
            /* Dark top border for emphasis */

            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            /* Rounded corners for the card */
            overflow: hidden;
            /* Ensures content fits within the card */
            display: flex;
            flex-direction: column;
            /* Stack children vertically */
        }

        .card-content {
            padding: 20px;
        }

        /* .card-title {
            font-size: 24px;
            color: #FFD700;
        } */

        /* .loader {
            display: none;
            margin: 10px auto;
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        } */

        .loader {
            display: none;
            margin: 10px auto;
            border: 4px solid #FFC0CB;
            /* Light Pink, same as card background */
            border-radius: 50%;
            border-top: 4px solid #FF69B4;
            /* Hot Pink, to stand out */
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .upload-box {
            margin: 20px auto;
            padding: 20px;
            background-color: #FFB6C1;
            /* Light Pink */
            color: #4A2C2A;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            text-align: center;
        }

        .modal {
            color: #fff;
        }

        .modal-content {
            background-color: #e364a8;
            /* Deep Pink */
            color: #FFFFFF;
            /* White Text */
        }

        @keyframes fadeInAnimation {
            0% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        /* .image-grid img:hover {
            transform: scale(1.1);
            border-color: #aaa;
        } */


        .card-content {
            padding: 20px;
        }

        /* .card-title {
            font-size: 24px;
            color: #bdb6ff;
        } */

        .card-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            /* Subtle separator */
            padding-bottom: 10px;
        }

        .image-grid {
            width: 100%;
            overflow: hidden;
            /* Hide parts outside the boundary */
        }

        /* .image-grid img {
            width: 100%;
            height: auto;
            transition: transform .2s;
        } */

        .image-grid img {
            width: 100%;
            height: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            /* More pronounced shadow */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            /* Smoother transition */
        }

        .image-grid img:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);

            /* Slight zoom on hover */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            nav {
                font-size: 18px;
                /* Smaller font size on smaller screens */
            }
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            #taskCards {
                grid-template-columns: 1fr;
                /* One column on small screens */
            }
        }

        footer {
            /* background-color: #2c3e50; */
            /* color: white; */
            border-top: 1px solid #444;
            background-color: #FFB6C1;
            /* Light Pink */
            color: #4A2C2A;
            text-align: center;
            padding: 10px 20px;
            font-size: 16px;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        footer a {
            color: #4da6ff;
            ;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        .content-header {
            padding: 20px;
            text-align: right;
            /* This aligns the button to the right */
        }

        .content-header button {
            background-color: #FFD700;
            /* Gold color */
            color: #333;
            border-radius: 4px;
            /* padding: 10px 15px; */
            font-size: 16px;
            cursor: pointer;
        }

        .content-header button:hover {
            background-color: #E6C300;
        }

        .upload-btn,
        .submit-btn {
            background-color: #FF1493;
            /* Deep Pink */
            color: #FFFFFF;
            /* White Text */
            border: none;
            /* padding: 10px 20px; */
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <nav>
        <div class="nav-wrapper">
            <img src="./static/logo_dark.png" alt="Dashboard Logo" style="height: 50px;">
            <!-- <button class="btn waves-effect waves-light" onclick="downloadPDF()">Download as PDF</button> -->
            <!-- Adjusted logo size -->
            Data Analysis Application
        </div>
        <!-- <button class="btn waves-effect waves-light" onclick="downloadPDF()" style="margin-right: auto;">Download as
            PDF</button> -->
    </nav>

    <!-- <button class="btn waves-effect waves-light" onclick="downloadPDF()">Download as PDF</button> -->


    <div class="content-header">
        <button id="downloadPdfButton" class="btn waves-effect waves-light" style="display: none;"
            onclick="downloadPDF()">Download as
            PDF</button>
    </div>


    <div class="upload-box">
        <input type="file" id="fileInput" name="file"><br><br>
        <!-- <button class="btn waves-effect waves-light" onclick="submitFile()">Upload</button> -->
        <input type="button" value="Upload" class="upload-btn btn waves-effect waves-light" onclick="submitFile()">


        <div id="loader" class="loader" style="display:none;"></div>
    </div>


    <div id="taskCards"></div>

    <div id="modal1" class="modal">
        <div class="modal-content">
            <img src="" id="modalImg" style="width:100%;">
        </div>
    </div>

    <footer>
        <div class="container">
            Â© 2024 Aigility AI. All rights reserved. <br>
            <a href="http://www.aigilityai.com" target="_blank">Try Aiternity's Application Builder</a>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var elems = document.querySelectorAll('.modal');
            // M.Modal.init(elems);
            var instances = M.Modal.init(elems);

        });

        function submitFile() {
            document.getElementById('loader').style.display = 'block';
            document.querySelector('.upload-btn').disabled = true;

            var formData = new FormData();
            var fileInput = document.getElementById('fileInput');
            formData.append('file', fileInput.files[0]);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/eda/upload', true);
            xhr.onload = function () {
                document.getElementById('loader').style.display = 'none';
                document.querySelector('.upload-btn').disabled = false;
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    displayTasks(response["EDA_output"]);
                } else {
                    document.getElementById('taskCards').innerHTML = '<p>Error uploading file.</p>';
                }
            };
            xhr.send(formData);
        }

        function displayTasks(tasks) {
            // console.log("Received task outputs ", tasks)
            window.currentTasks = tasks;
            const taskContainer = document.getElementById('taskCards');
            taskContainer.innerHTML = '';

            if (tasks.length > 0) {
                document.getElementById('downloadPdfButton').style.display = 'inline-block'; // Show the button if tasks are present
            } else {
                document.getElementById('downloadPdfButton').style.display = 'none'; // Hide the button if no tasks
            }

            tasks.forEach(task => {
                const card = document.createElement('div');
                card.className = 'card';
                // const content = isTableData(task.stdout) ?
                //     `<pre class="scrollable-pre">${task.stdout}</pre>` :
                //     `<pre class="normal-pre">${task.stdout}</pre>`;

                const content = task.stdout && task.stdout.trim() ?
                    (isTableData(task.stdout) ?
                        `<pre class="scrollable-pre">${task.stdout}</pre>` :
                        `<pre class="normal-pre">${task.stdout}</pre>`) :
                    '';


                card.innerHTML = `
                                <div class="card-content">
                                    <span class="card-title">${task.task_description}</span>
                                    ${task.reject_feedback && task.reject_feedback.trim() ? `<p>Feedback:<br> ${task.reject_feedback.trim().replace(/\n/g, '<br>')}</p>` : ''}
                                    ${content}
                                </div>
                                <div class="card-action image-grid">
                                    ${task.images_saved.map(image => `<img src="${image}" onclick="openModal('${image}');" alt="Plot Image">`).join('')}
                                </div>
                            `;
                taskContainer.appendChild(card);
            });
        }

        function downloadPDF() {
            fetch('/eda/download-pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ tasks: window.currentTasks }) // Assuming currentTasks is the global state holding the tasks data
            })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;

                    const now = new Date();
                    const dateString = now.toISOString().split('T')[0]; // Extracts date part only ('YYYY-MM-DD')
                    const timeString = now.toTimeString().split(' ')[0].replace(/:/g, '-'); // Extracts time and replaces ':' with '-'

                    // Append the formatted date and time to the filename
                    a.download = `data_analysis_report_${dateString}_${timeString}.pdf`;


                    // a.download = "data_analysis_report.pdf";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                })
                .catch(error => console.error('Error downloading the PDF:', error));
        }


        function isTableData(data) {
            const pandasPattern = /\[\d+\s+rows\s+x\s+\d+\s+columns\]/; // Regex to detect "[number rows x number columns]"
            return pandasPattern.test(data) || (data.includes('\n') && data.split('\n').every(row => row.trim().split(/\s+/).length === data.split('\n')[0].trim().split(/\s+/).length));
        }

        function openModal(imageUrl) {
            const modalImg = document.getElementById('modalImg');
            modalImg.src = imageUrl;
            const instance = M.Modal.getInstance(document.getElementById('modal1'));
            instance.open();
        }
    </script>
</body>

</html>